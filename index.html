<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StickDown</title>
  <!-- iOS full-screen when added to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="StickDown" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23007aff'/%3E%3Ctext x='50' y='60' font-size='60' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b0c10; --card:#151821; --muted:#9ba1a6; --acc:#0ea5e9; --green:#22c55e; --red:#ef4444; --white:#f8fafc }
    *{box-sizing:border-box;}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--white);}
    .wrap{max-width:600px; margin:0 auto; padding:16px;}
    .card{background:var(--card); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{font-size:28px; margin:8px 0 0}
    .row{display:flex; gap:12px}
    .grow{flex:1}
    .muted{color:var(--muted)}
    button{appearance:none; border:none; border-radius:16px; padding:14px 16px; font-weight:700; color:#fff; background:var(--acc); width:100%; font-size:18px;}
    button.secondary{background:#2a2f3b; color:#fff;}
    .big{font-size:42px; font-weight:800; letter-spacing:1px}
    .ok{color:var(--green)} .warn{color:var(--red)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:14px; color:var(--muted)}
    input[type="number"], input[type="time"]{width:100%; padding:10px; border-radius:12px; border:1px solid #2a2f3b; background:#0f1117; color:#fff}
    .bar{height:10px; background:#2a2f3b; border-radius:999px; overflow:hidden}
    .bar>div{height:100%; background:linear-gradient(90deg, #22c55e, #0ea5e9); width:0%}
    .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:opacity .2s ease}
    .toast.show{opacity:1}
    a{color:#7dd3fc}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="align-items:center">
    <div class="grow">
      <h1>StickDown</h1>
      <div class="muted" id="today"></div>
    </div>
    <button class="secondary" id="btnSettings" aria-label="Impostazioni">⚙️</button>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Ultimo stick</div>
    <div class="big" id="sinceLast">—</div>
    <div id="advice" class="muted"></div>
    <div class="bar" style="margin-top:10px"><div id="progress"></div></div>
  </div>

  <div class="row" style="margin-top:12px">
    <button id="btnPlus">+1 stick</button>
    <button class="secondary" id="btnUndo">Annulla</button>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <div class="muted">Intervallo consigliato</div>
        <div id="reco" class="big">—</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Obiettivo</div>
        <div id="goal" class="big">—</div>
      </div>
    </div>
    <div class="muted" id="hint">In base alle ore di veglia stimate.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="grid">
      <div>
        <label>Stick max/giorno</label>
        <input type="number" id="inpTarget" min="1" max="40" step="1" />
      </div>
      <div>
        <label>Ora inizio veglia</label>
        <input type="time" id="awakeStart" />
      </div>
      <div>
        <label>Ora fine veglia</label>
        <input type="time" id="awakeEnd" />
      </div>
      <div style="align-self:end">
        <button class="secondary" id="btnSave">Salva impostazioni</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Consiglio: imposta la tua solita finestra di veglia (es. 07:30 – 23:30). L’app calcola i minuti disponibili e divide per il tuo obiettivo giornaliero → ottieni il ritmo consigliato tra due stick.</div>
  </div>

  <div class="muted" style="margin-top:16px">
    Suggerimento Siri: crea una Scorciatoia che apre l’URL <code>?add=1</code> della tua app (vedi istruzioni più sotto) per registrare uno stick a voce.
  </div>

  <div class="card" style="margin-top:12px">
    <details>
      <summary>Come usare con Siri (senza Mac)</summary>
      <ol>
        <li>Metti online questa pagina (GitHub Pages va benissimo — vedi passaggi più sotto).</li>
        <li>In “Comandi Rapidi” su iPhone, crea un nuovo comando: azione <strong>Apri URL</strong> → incolla l’URL del tuo sito con <code>?add=1</code> (es. <em>https://tuonome.github.io/stickdown/?add=1</em>).</li>
        <li>Opzionale: aggiungi azione <strong>Mostra notifica</strong> con “Aggiunto +1”.</li>
        <li>Dai un nome tipo “Aggiungi uno stick” e assegna la frase a Siri.</li>
      </ol>
      Quando esegui il comando, la pagina si apre, registra +1 e aggiorna il timer automaticamente.
    </details>
  </div>

  <div class="card" style="margin-top:12px">
    <details>
      <summary>Mettere online con GitHub Pages (da Windows)</summary>
      <ol>
        <li>Crea un account su GitHub e un nuovo repository chiamato <strong>stickdown</strong>.</li>
        <li>Copia questo file come <code>index.html</code> nel repo (puoi usare “Add file → Create new file” online).</li>
        <li>Vai su <em>Settings → Pages</em>, come <em>Source</em> scegli <strong>Deploy from a branch</strong>, branch <strong>main</strong>, cartella <strong>root</strong> e salva.</li>
        <li>Dopo qualche secondo avrai l’indirizzo <em>https://tuonome.github.io/stickdown</em>.</li>
        <li>Su iPhone, apri quell’indirizzo in Safari → Condividi → <strong>Aggiungi a Home</strong> per usarla a tutto schermo.</li>
      </ol>
    </details>
  </div>
</div>

<div class="toast" id="toast">Aggiunto +1</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const todayKey = () => new Date().toISOString().slice(0,10);
  const LS = {
    get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch(e){ return def } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
  };

  // --- Settings ---
  const defaults = { target: 10, awakeStart: "07:30", awakeEnd: "23:30" };
  const settings = LS.get('settings', defaults);
  const day = LS.get('day:'+todayKey(), { count:0, last:null });

  // URL param quick add (?add=1)
  const params = new URLSearchParams(location.search);
  if(params.get('add') === '1') { day.count++; day.last = new Date().toISOString(); LS.set('day:'+todayKey(), day); showToast("Aggiunto +1"); history.replaceState({}, '', location.pathname); }

  // Elements
  const elToday = $('#today'), elSince = $('#sinceLast'), elAdvice = $('#advice');
  const elReco = $('#reco'), elGoal = $('#goal'), elHint = $('#hint');
  const elProgress = $('#progress');
  const inpTarget = $('#inpTarget');
  const awakeStart = $('#awakeStart');
  const awakeEnd = $('#awakeEnd');

  // Init form
  inpTarget.value = settings.target;
  awakeStart.value = settings.awakeStart;
  awakeEnd.value = settings.awakeEnd;

  // Helpers
  function diffFmt(sec){ sec = Math.max(0, Math.floor(sec)); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; if(h>0)return `${h}h ${m}m ${s}s`; if(m>0)return `${m}m ${s}s`; return `${s}s`; }
  function minutesBetween(t1, t2){
    const [h1,m1] = t1.split(':').map(Number), [h2,m2] = t2.split(':').map(Number);
    let a = h1*60+m1, b = h2*60+m2; if (b<=a) b += 24*60; return b-a; // supports crossing midnight
  }
  function suggestedInterval(){
    const awake = minutesBetween(settings.awakeStart, settings.awakeEnd);
    return Math.max(5, Math.floor(awake / Math.max(1, settings.target)));
  }

  function updateUI(){
    const target = settings.target;
    const remain = Math.max(0, target - day.count);
    elToday.textContent = `Oggi: ${day.count} / ${target}`;
    elGoal.textContent = target;

    const recoMin = suggestedInterval();
    elReco.textContent = `${recoMin} min`;

    const last = day.last ? new Date(day.last) : null;
    if(!last){
      elSince.textContent = 'Nessuno oggi';
      elAdvice.textContent = '';
      elProgress.style.width = '0%';
      return;
    }
    const sec = (Date.now()-last.getTime())/1000;
    elSince.textContent = diffFmt(sec);

    const need = recoMin*60;
    const wait = Math.max(0, need - sec);
    if(wait>0){
      elAdvice.innerHTML = `<span class='warn'>Aspetta ancora ${diffFmt(wait)} per restare nel ritmo consigliato.</span>`;
    } else {
      elAdvice.innerHTML = `<span class='ok'>Puoi accendere senza sforare il ritmo medio.</span>`;
    }
    const pct = Math.min(100, Math.floor( (sec/need)*100 ));
    elProgress.style.width = pct+"%";

    elHint.textContent = `In base alla veglia: ${settings.awakeStart} → ${settings.awakeEnd}`;
  }

  // Buttons
  $('#btnPlus').addEventListener('click', ()=>{ day.count++; day.last=new Date().toISOString(); LS.set('day:'+todayKey(), day); updateUI(); showToast('Aggiunto +1'); });
  $('#btnUndo').addEventListener('click', ()=>{ if(day.count>0){ day.count--; LS.set('day:'+todayKey(), day); updateUI(); showToast('Annullato'); }});
  $('#btnSave').addEventListener('click', ()=>{
    settings.target = Math.max(1, parseInt(inpTarget.value||'10',10));
    settings.awakeStart = awakeStart.value || '07:30';
    settings.awakeEnd = awakeEnd.value || '23:30';
    LS.set('settings', settings); updateUI(); showToast('Impostazioni salvate');
  });
  $('#btnSettings').addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}) });

  // Midnight reset
  setInterval(()=>{
    const key = 'day:'+todayKey();
    // if changed day, start new
    if(!localStorage.getItem(key)){
      LS.set(key, {count:0, last:null});
      location.reload();
    }
  }, 30000);

  // Tick UI
  setInterval(updateUI, 1000);
  updateUI();

  function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
})();
</script>
</body>
</html>
